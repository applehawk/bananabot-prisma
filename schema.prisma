generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String        @id @default(cuid())
  telegramId        BigInt        @unique
  username          String?
  firstName         String?
  lastName          String?
  languageCode      String        @default("en")
  credits           Float         @default(0)
  reservedCredits   Float         @default(0)
  personalMargin    Float         @default(0) // Personal margin for this user (e.g. 0.10 for +10%)
  freeCreditsUsed   Float         @default(0)
  totalGenerated    Int           @default(0)
  referralCode      String        @unique
  referredBy        String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastActiveAt      DateTime      @default(now())
  dailyBonus        DailyBonus?
  isBlocked         Boolean       @default(false)
  isSubscribed      Boolean       @default(false)
  isRuleEngineEnabled Boolean     @default(true) // For SELECTED_USERS_ONLY mode

  generations       Generation[]
  referralsReceived Referral[]    @relation("Referred")
  referralsGiven    Referral[]    @relation("Referrer")
  transactions      Transaction[]
  settings          UserSettings?
  adminMessages     AdminMessage[]
  chatMessages      ChatMessage[]
  userBurnableBonuses UserBurnableBonus[]

  @@index([telegramId])
  @@index([referralCode])
  @@index([createdAt])


  // [NEW] Tags for FSM segmentation (secondary states)
  tags String[] @default([])
  
  // [NEW] 2-Level FSM Architecture
  lifecycleState LifecycleState @default(NEW)
  overlays       UserOverlay[]

  // [DEPRECATED] FSM State tracking (Keep for now until migration complete)
  fsmState    UserFSMState?
  fsmHistory  UserFSMHistory[]
}

model UserSettings {
  id                String            @id @default(cuid())
  userId            String            @unique
  aspectRatio       String            @default("1:1")
  numberOfImages    Int               @default(1)
  safetyLevel       String            @default("BLOCK_MEDIUM_AND_ABOVE")
  language          String            @default("en")
  hdQuality         Boolean           @default(false)
  isSubscriptionRequired Boolean      @default(true)
  autoEnhance       Boolean           @default(false)
  useNegativePrompt Boolean           @default(true)
  notifyOnComplete  Boolean           @default(true)
  notifyOnBonus     Boolean           @default(true)
  timezone          String            @default("UTC") // [NEW] User Timezone
  askAspectRatio    Boolean           @default(false) // Option to ask for aspect ratio
  enhancementPrompt String?           @default("You are an expert at writing prompts for AI image generation.\nTake this user prompt and enhance it to create a detailed, high-quality image generation prompt.\nAdd details about style, lighting, composition, and quality while keeping the original intent.\nReturn ONLY the enhanced prompt, nothing else.")
  selectedModelId   String            @default("gemini-2.5-flash-image")
  selectedModel     ModelTariff       @relation(fields: [selectedModelId], references: [modelId])
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ... existing models ...

model ModelTariff {
  id               String   @id @default(cuid())
  modelId          String   @unique // "gemini-2.5-flash", "sora-2", "veo-3.1-fast"
  providerId       String
  provider         Provider @relation(fields: [providerId], references: [id])

  name             String   // Human readable name
  displayName      String?  // e.g. "Gemini 2.5 Flash (Preview)"
  description      String?

  // === Prices (USD) ===
  inputPrice            Float?    // per 1M tokens
  inputLongPrice        Float?    // if >128kâ€“200k tokens
  outputPrice           Float?    // per 1M tokens (text/thinking)
  outputLongPrice       Float?    // for long output
  outputImagePrice      Float?    // per 1M tokens (image generation)
  outputVideoPrice      Float?    // USD per 1 second video
  outputAudioPrice      Float?    // USD per 1 minute audio

  // === Units ===
  priceUnit             String?   // "per_million_tokens" | "per_second" | "per_credit" | "per_generation" | "per_million_pixels"
  creditsPerSecond      Float?    // credits per second
  creditsPerGeneration  Float?    // credits per generation
  creditPriceUsd        Float?    // Price per credit in USD

  // === Multimedia Tokens ===
  inputImageTokens      Int?      // tokens for input image (e.g. 560 for Gemini)
  imageTokensLowRes     Int?      // tokens for <=2K image output
  imageTokensHighRes    Int?      // tokens for 4K+ image output
  videoTokensPerSecond  Int?      // tokens per second of video
  audioTokensPerMinute  Int?      // tokens per minute of audio

  inputImagesLimit      Int       @default(5) // Max number of input images allowed


  // === Technical Parameters ===
  maxTokens             Int?
  maxVideoDuration      Int?
  maxImageResolution    String?
  supportedResolutions  String[]
  hasNativeAudio        Boolean   @default(false)
  hasImageGeneration    Boolean   @default(false)
  hasVideoGeneration    Boolean   @default(false)

  // === API ===
  modelNameOnProvider   String?
  endpoints             Json?

  // === Margins ===
  modelMargin           Float     @default(0) // Extra margin for this specific model (e.g. 0.10 for +10%)

  // === Status ===
  isActive              Boolean   @default(true)
  isPreview             Boolean   @default(false)
  isSelfHosted          Boolean   @default(false)
  validFrom             DateTime?
  validUntil            DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userSettings          UserSettings[]
  generations           Generation[]
}

model Provider {
  id                    String   @id @default(cuid())
  slug                  String   @unique // "google", "openai", "anthropic"
  name                  String
  baseUrl               String?

  // Authorization
  authType              AuthType
  authHeaderName        String?
  authHeaderPrefix      String?
  authQueryParam        String?
  authTokenUrl          String?
  authScope             String?

  models                ModelTariff[]
}

enum AuthType {
  API_KEY
  BEARER_TOKEN
  X_API_KEY
  GOOGLE_OAUTH
  NONE
}

model SystemSettings {
  id          String   @id @default("singleton")
  key         String   @unique
  usdRubRate      Float    @default(100)
  hostingCost     Float    @default(0)
  systemMargin    Float    @default(0) // Global system margin (e.g. 0.05 for +5%)
  telegramChannelId String?
  isSubscriptionRequired Boolean @default(false)
  isRetentionEnabled Boolean @default(false)
  creditsPerUsd   Float    @default(100) // How many credits for 1 USD
  freeCreditsAmount Float  @default(3)   // Free credits for new users
  referralBonusAmount Float @default(50) // Bonus for referrer
  referralFirstPurchaseBonus Float @default(150) // Bonus for first purchase of referral
  defaultNewUserModelId String @default("gemini-2.5-flash-image") // Default model for new users
  tripwirePackageId String? // Package to offer when user runs out of credits

  // Rule Engine Settings
  ruleEngineEnabled Boolean @default(true)
  ruleEngineMode    RuleEngineMode @default(ALL)
  ruleEngineReferenceDate DateTime? // Date cutoff for NEW/OLD modes

  updatedAt       DateTime @updatedAt
}


model Generation {
  id             String           @id @default(cuid())
  userId         String
  type           GenerationType
  prompt         String
  negativePrompt String?
  enhancedPrompt String?
  aspectRatio    String           @default("1:1")
  numberOfImages Int              @default(1)
  safetyLevel    String
  imageUrl       String?
  fileId         String?
  thumbnailUrl   String?
  status         GenerationStatus @default(PENDING)
  creditsUsed    Float
  errorMessage   String?
  metadata       Json?
  processingTime Int?
  reservedAmount Float            @default(0)
  createdAt      DateTime         @default(now())
  completedAt    DateTime?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  inputImages    InputImage[]

  // Cost & Tokens
  modelId        String?
  model          ModelTariff?     @relation(fields: [modelId], references: [modelId])
  inputTokens    Int?
  outputTokens   Int?
  totalTokens    Int?
  totalCostUsd   Float?
  costDetails    Json?            // Breakdown: { baseCost, margins: { system, user, model }, finalCost }

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
  @@index([modelId])
}

model InputImage {
  id           String     @id @default(cuid())
  generationId String
  fileId       String
  fileUrl      String?
  order        Int
  createdAt    DateTime   @default(now())
  generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
  @@index([order])
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float?
  creditsAdded  Float
  paymentMethod PaymentMethod     @default(FREE)
  paymentId     String?
  currency      String?           @default("USD")
  status        TransactionStatus @default(PENDING)
  metadata      Json?
  description   String?
  createdAt     DateTime          @default(now())
  completedAt   DateTime?
  isFinal       Boolean           @default(false)
  packageId     String?
  package       CreditPackage?    @relation(fields: [packageId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([paymentId])
  @@index([createdAt])
}

model Referral {
  id                 String   @id @default(cuid())
  referrerId         String
  referredId         String
  bonusGranted       Boolean  @default(false)
  bonusAmount        Float    @default(3)
  firstPurchase      Boolean  @default(false)
  firstPurchaseBonus Float    @default(5)
  createdAt          DateTime @default(now())
  referred           User     @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)
  referrer           User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
}

model DailyBonus {
  id            String    @id @default(cuid())
  userId        String    @unique
  streakDays    Int       @default(0)
  lastClaimDate DateTime?
  totalBonuses  Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastClaimDate])
}

model CreditPackage {
  id            String        @id @default(cuid())
  name          String
  credits       Float
  price         Float
  currency      String        @default("USD")
  discount      Int           @default(0)
  popular       Boolean       @default(false)
  active        Boolean       @default(true)
  priceYooMoney Float?
  priceStars    Int?
  priceCrypto   Float?
  description   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]
  broadcasts    Broadcast[]

  
  @@index([active])
  @@index([popular])
}

model AdminUser {
  id         String   @id @default(cuid())
  telegramId BigInt?  @unique
  username   String?  @unique
  password   String?
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())
  
  adminMessages AdminMessage[]
  broadcasts    Broadcast[]

  @@index([telegramId])
  @@index([username])
}

model Analytics {
  id                    String   @id @default(cuid())
  date                  DateTime @unique @default(now())
  newUsers              Int      @default(0)
  activeUsers           Int      @default(0)
  totalGenerations      Int      @default(0)
  textToImage           Int      @default(0)
  imageToImage          Int      @default(0)
  multiImage            Int      @default(0)
  totalRevenue          Float    @default(0)
  totalCreditsUsed      Float    @default(0)
  totalCreditsPurchased Float    @default(0)
  paymentsYooMoney      Int      @default(0)
  paymentsStars         Int      @default(0)
  paymentsCrypto        Int      @default(0)

  @@index([date])
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  credits     Float
  discount    Int?
  maxUses     Int?
  currentUses Int       @default(0)
  expiresAt   DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([active])
}

model PromoCodeUsage {
  id           String   @id @default(cuid())
  code         String
  userId       String
  creditsGiven Float
  usedAt       DateTime @default(now())

  @@unique([code, userId])
  @@index([userId])
  @@index([code])
}

model AdminMessage {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminId     String?
  admin       AdminUser? @relation(fields: [adminId], references: [id])
  
  message     String
  sentAt      DateTime @default(now())
  isBroadcast Boolean  @default(false)
  broadcastId String?
  broadcast   Broadcast? @relation(fields: [broadcastId], references: [id])
  
  status      String   @default("SENT") // SENT, FAILED
  error       String?

  burnableBonusId        String?
  burnableBonus          BurnableBonus? @relation(fields: [burnableBonusId], references: [id])

  @@index([userId])
  @@index([sentAt])
  @@index([broadcastId])
}

model Broadcast {
  id          String   @id @default(cuid())
  message     String
  status      BroadcastStatus @default(PENDING)
  scheduledFor DateTime?
  targetNotSubscribed Boolean @default(false)
  botToken    String?
  startedAt   DateTime?
  completedAt DateTime?
  
  totalUsers  Int      @default(0)
  sentCount   Int      @default(0)
  failedCount Int      @default(0)
  
  targetUserIds String[]

  creditPackageId String?
  creditPackage   CreditPackage? @relation(fields: [creditPackageId], references: [id])
  
  createdBy   String?
  creator     AdminUser? @relation(fields: [createdBy], references: [id])
  
  messages    AdminMessage[]

  burnableBonusId        String?
  burnableBonus          BurnableBonus? @relation(fields: [burnableBonusId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
}

enum GenerationType {
  TEXT_TO_IMAGE
  IMAGE_TO_IMAGE
  MULTI_IMAGE
  BATCH
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionType {
  PURCHASE
  BONUS
  REFERRAL
  DAILY_BONUS
  ADMIN_ADJUSTMENT
  GENERATION_COST
  REFUND
  TRANSFER
  EXPIRED_BONUS
}

enum PaymentMethod {
  YOOMONEY
  TELEGRAM_STARS
  CRYPTO
  FREE
  ADMIN
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  REFUNDED
  FAILED
  CANCELLED
  TIMEOUT
}

enum BroadcastStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}


model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  mode      String   @default("help") 
  
  isFromUser Boolean @default(true)
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([mode])
}



model BurnableBonus {
  id                     String   @id @default(cuid())
  amount                 Float
  expiresInHours         Int?     // Duration in hours
  expiresAt              DateTime? // Specific date deadline

  // Conditions to keep (make permanent)
  conditionGenerations   Int?     @default(1)
  conditionTopUpAmount   Float?

  // Relations

  broadcasts             Broadcast[]
  adminMessages          AdminMessage[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model UserBurnableBonus {
  id                     String   @id @default(cuid())
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount                 Float
  deadline               DateTime

  // Snapshot of conditions
  generationsRequired    Int?
  topUpAmountRequired    Float?

  // Progress tracking
  generationsMade        Int      @default(0)
  topUpMade              Float    @default(0)

  status                 BurnableBonusStatus @default(ACTIVE)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([deadline])
}

enum BurnableBonusStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  REVOKED
}

// ==========================================
// FSM RETENTION SYSTEM MODELS
// ==========================================

// 1. Versioning
model FSMVersion {
  id        Int      @id @default(autoincrement())
  name      String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  states      FSMState[]
  transitions FSMTransition[]
}

// 2. Enums
enum FSMTriggerType {
  EVENT
  TIME
}

enum FSMEvent {
  // System
  BOT_START
  
  // Generation
  FIRST_GENERATION
  GENERATION
  GENERATION_PENDING 
  GENERATION_FAILED
  MODEL_SELECTED
  
  // Payment
  PAYMENT_CLICKED
  PAYMENT_PENDING
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  PAYMENT_TIMEOUT
  PACKAGE_VIEW
  PACKAGE_PURCHASE
  
  // Credits
  CREDITS_CHANGED
  CREDITS_ZERO
  
  // Internal
  TIMEOUT
  LAST_ACTIVITY
  UNSUBSCRIBE
  
  // Referral
  REFERRAL_INVITE
  REFERRAL_PAID

  // Channel
  CHANNEL_SUBSCRIPTION

  // Offers
  TRIPWIRE_SHOWN
  INSUFFICIENT_CREDITS

  // Bonus
  BONUS_GRANTED
  BONUS_EXPIRED

  // Lifecycle
  USER_BLOCKED
  USER_UNBLOCKED
  GENERATION_COMPLETED
}

enum FSMActionType {
  // Allowed Infrastructure Actions
  LOG_EVENT
  TAG_USER
  RESET_COUNTER
  SYNC_ANALYTICS

  // [DEPRECATED in FSM, Moved to Rules] 
  // Kept for legacy compatibility / fallback
  SEND_MESSAGE
  SEND_SPECIAL_OFFER
  GRANT_BURNABLE_BONUS
  SHOW_TRIPWIRE
  ENABLE_REFERRAL
  SWITCH_MODEL_HINT
  
  NO_ACTION
}

model FSMState {
  id          String   @id @default(cuid())
  
  // Versioning
  versionId   Int
  version     FSMVersion @relation(fields: [versionId], references: [id])

  name        String   // Unique per version
  description String?
  group       String?      @default("General")
  isInitial   Boolean  @default(false)
  isTerminal  Boolean  @default(false) // Stops evaluation
  
  // UI Coordinates
  positionX   Float    @default(0)
  positionY   Float    @default(0)

  // Transitions
  transitions         FSMTransition[] @relation("FromState")
  incomingTransitions FSMTransition[] @relation("ToState")

  // Users currently in this state
  currentUsers UserFSMState[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([versionId, name])
}

model FSMTransition {
  id          String   @id @default(cuid())
  
  versionId   Int
  version     FSMVersion @relation(fields: [versionId], references: [id])

  fromStateId String
  toStateId   String
  fromState   FSMState @relation("FromState", fields: [fromStateId], references: [id], onDelete: Cascade)
  toState     FSMState @relation("ToState", fields: [toStateId], references: [id], onDelete: Cascade)
  
  triggerType FSMTriggerType @default(EVENT)

  // Event Trigger
  triggerEvent FSMEvent?
  
  // Time Trigger
  timeFrom       String? // "entered_state" | "last_generation" | "last_payment"
  timeoutMinutes Int?
  
  // Conditions
  conditions  FSMCondition[]
  
  // Actions
  actions     FSMAction[]

  priority    Int @default(0) 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([fromStateId])
  @@index([triggerEvent])
}

model FSMCondition {
  id            String       @id @default(cuid())
  transitionId  String
  transition    FSMTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)
  
  groupId       Int         @default(0) // AND within group, OR between groups

  // DSL: Field Operator Value
  field         String      
  operator      String      
  value         String      

  createdAt     DateTime @default(now())
}

model FSMAction {
  id            String       @id @default(cuid())
  transitionId  String
  transition    FSMTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)
  
  type          FSMActionType
  config        Json?        
  order         Int          @default(0)

  createdAt     DateTime @default(now())
}

model UserFSMState {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stateId       String
  state         FSMState @relation(fields: [stateId], references: [id])
  
  versionId     Int      // Track which version user is on
  
  enteredAt     DateTime @default(now())
  lastCheckedAt DateTime @default(now()) 
  
  context       Json?    
  
  updatedAt     DateTime @updatedAt
  
  @@index([stateId])
  @@index([lastCheckedAt])
}

model UserFSMHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fromStateId   String?
  toStateId     String
  
  triggerEvent  FSMEvent?
  
  // Snapshot
  transitionId  String?
  actionsTaken  Json?   
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([toStateId])
}

// Metrics
model FSMStateMetric {
  stateId        String
  usersCount     Int
  avgTimeSeconds Int
  p90TimeSeconds Int
  calculatedAt   DateTime @default(now())

  @@id([stateId, calculatedAt])
}

// 2-Level Lifecycle FSM
enum LifecycleState {
  NEW
  ACTIVATING
  ACTIVE_FREE
  PAYWALL
  PAID_ACTIVE
  INACTIVE
  CHURNED
  BLOCKED
}


enum OverlayType {
  TRIPWIRE
  BONUS
  REFERRAL
  SPECIAL_OFFER
  ONBOARDING
  INFO
}

enum OverlayState {
  ELIGIBLE
  ACTIVE
  EXPIRING
  EXPIRED
  DISMISSED
  CONVERTED
}

enum OverlayEventType {
  REQUESTED
  ACTIVATED
  DELIVERED
  CLICKED
  CONVERTED
  EXPIRED
  DISMISSED
}

enum RuleTrigger {
  BOT_START
  GENERATION_REQUESTED
  GENERATION_COMPLETED
  CREDITS_CHANGED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  TIME
  ADMIN_EVENT
  OVERLAY_ACTIVATED
  OVERLAY_EXPIRED
  STATE_CHANGED
  REFERRAL_INVITE
  REFERRAL_PAID
  STREAK_REACHED
  INSUFFICIENT_CREDITS
  CHANNEL_SUBSCRIPTION
  UI_EVENT
}

enum RuleActionType {
  ACTIVATE_OVERLAY
  DEACTIVATE_OVERLAY
  EMIT_EVENT
  TAG_USER
  LOG_EVENT
  NO_OP
}

enum RuleConditionOperator {
  EQUALS
  NOT_EQUALS
  GT
  GTE
  LT
  LTE
  IN
  NOT_IN
  EXISTS
  NOT_EXISTS
}

model UserOverlay {
  id            String        @id @default(cuid())
  userId        String
  type          OverlayType
  state         OverlayState
  metadata      Json?
  credits       Int?          // for BONUS
  expiresAt     DateTime?
  activatedAt   DateTime      @default(now())
  deactivatedAt DateTime?

  user          User           @relation(fields: [userId], references: [id])

  // New Engine Relations
  overlayId     String?
  overlay       Overlay?       @relation(fields: [overlayId], references: [id])
  variantId     String?
  variant       OverlayVariant? @relation(fields: [variantId], references: [id])

  scheduledFor  DateTime?      // For delayed delivery

  @@index([userId, type])
  @@index([state, expiresAt])
}

model Overlay {
  id          String   @id @default(cuid())
  code        String   @unique
  type        OverlayType
  priority    Int      @default(0)
  isActive    Boolean  @default(true)

  // Delivery Rules
  ttlSeconds      Int?
  cooldownSeconds Int?
  maxImpressions  Int?

  // Scheduling
  defaultDelaySeconds Int?   // Delay before showing
  allowedTimeWindow   String? // "09:00-21:00"

  // Suppression
  allowedLifecycleStates LifecycleState[]
  blockedByTypes         OverlayType[]

  payload     Json?    
  variants    OverlayVariant[]
  
  // Relations
  activations UserOverlay[]
  events      OverlayEvent[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OverlayVariant {
  id        String   @id @default(cuid())
  overlayId String
  overlay   Overlay  @relation(fields: [overlayId], references: [id], onDelete: Cascade)
  
  name      String
  weight    Int      @default(0)
  payload   Json     
  isActive  Boolean  @default(true)

  activations UserOverlay[]
  events      OverlayEvent[]
}

model OverlayEvent {
  id          String   @id @default(cuid())
  userId      String
  overlayId   String
  variantId   String?
  
  event       OverlayEventType 
  sourceRule  String?          
  
  createdAt   DateTime @default(now())
  metadata    Json?

  overlay     Overlay @relation(fields: [overlayId], references: [id], onDelete: Cascade)
  variant     OverlayVariant? @relation(fields: [variantId], references: [id])
}

model RuleGroup {
  id        String   @id @default(cuid())
  name      String   @unique
  order     Int      @default(0)
  rules     Rule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Rule {
  id          String       @id @default(cuid())
  code        String       @unique
  isActive    Boolean      @default(true)
  priority    Int          @default(0)
  trigger     RuleTrigger
  description String?
  
  // Relations
  groupId     String?      
  group       RuleGroup?   @relation(fields: [groupId], references: [id])


  conditions  RuleCondition[]
  actions     RuleAction[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model RuleCondition {
  id        String                 @id @default(cuid())
  ruleId    String
  field     String                 // e.g. "lifecycle", "credits", "overlay.TRIPWIRE"
  operator  RuleConditionOperator
  value     String?
  groupId   Int                    @default(0)

  rule      Rule                   @relation(fields: [ruleId], references: [id])

  @@index([ruleId, groupId])
}

model RuleAction {
  id        String          @id @default(cuid())
  ruleId    String
  type      RuleActionType
  params    Json?
  order     Int             @default(0)

  rule      Rule            @relation(fields: [ruleId], references: [id])

  @@index([ruleId, order])
}



enum RuleEngineMode {
  ALL
  NEW_USERS_ONLY
  OLD_USERS_ONLY
  SELECTED_USERS_ONLY
}
