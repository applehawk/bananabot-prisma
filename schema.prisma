generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  telegramId        BigInt        @unique
  username          String?
  firstName         String?
  lastName          String?
  languageCode      String        @default("en")
  credits           Float         @default(0)
  reservedCredits   Float         @default(0)
  personalMargin    Float         @default(0) // Personal margin for this user (e.g. 0.10 for +10%)
  freeCreditsUsed   Int           @default(0)
  totalGenerated    Int           @default(0)
  referralCode      String        @unique
  referredBy        String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastActiveAt      DateTime      @default(now())
  dailyBonus        DailyBonus?
  isSubscribed      Boolean       @default(false)
  generations       Generation[]
  referralsReceived Referral[]    @relation("Referred")
  referralsGiven    Referral[]    @relation("Referrer")
  transactions      Transaction[]
  settings          UserSettings?
  adminMessages     AdminMessage[]
  chatMessages      ChatMessage[]

  @@index([telegramId])
  @@index([referralCode])
  @@index([createdAt])
}

model UserSettings {
  id                String            @id @default(cuid())
  userId            String            @unique
  aspectRatio       String            @default("1:1")
  numberOfImages    Int               @default(1)
  safetyLevel       String            @default("BLOCK_MEDIUM_AND_ABOVE")
  language          String            @default("en")
  hdQuality         Boolean           @default(false)
  isSubscriptionRequired Boolean      @default(true)
  autoEnhance       Boolean           @default(true)
  useNegativePrompt Boolean           @default(true)
  notifyOnComplete  Boolean           @default(true)
  notifyOnBonus     Boolean           @default(true)
  askAspectRatio    Boolean           @default(false) // Option to ask for aspect ratio
  selectedModelId   String            @default("gemini-2.5-flash-image")
  selectedModel     ModelTariff       @relation(fields: [selectedModelId], references: [modelId])
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ... existing models ...

model ModelTariff {
  id               String   @id @default(cuid())
  modelId          String   @unique // "gemini-2.5-flash", "sora-2", "veo-3.1-fast"
  providerId       String
  provider         Provider @relation(fields: [providerId], references: [id])

  name             String   // Human readable name
  displayName      String?  // e.g. "Gemini 2.5 Flash (Preview)"
  description      String?

  // === Prices (USD) ===
  inputPrice            Float?    // per 1M tokens
  inputLongPrice        Float?    // if >128kâ€“200k tokens
  outputPrice           Float?    // per 1M tokens (text/thinking)
  outputLongPrice       Float?    // for long output
  outputImagePrice      Float?    // per 1M tokens (image generation)
  outputVideoPrice      Float?    // USD per 1 second video
  outputAudioPrice      Float?    // USD per 1 minute audio

  // === Units ===
  priceUnit             String?   // "per_million_tokens" | "per_second" | "per_credit" | "per_generation" | "per_million_pixels"
  creditsPerSecond      Float?    // credits per second
  creditsPerGeneration  Float?    // credits per generation
  creditPriceUsd        Float?    // Price per credit in USD

  // === Multimedia Tokens ===
  inputImageTokens      Int?      // tokens for input image (e.g. 560 for Gemini)
  imageTokensLowRes     Int?      // tokens for <=2K image output
  imageTokensHighRes    Int?      // tokens for 4K+ image output
  videoTokensPerSecond  Int?      // tokens per second of video
  audioTokensPerMinute  Int?      // tokens per minute of audio

  // === Technical Parameters ===
  maxTokens             Int?
  maxVideoDuration      Int?
  maxImageResolution    String?
  supportedResolutions  String[]
  hasNativeAudio        Boolean   @default(false)
  hasImageGeneration    Boolean   @default(false)
  hasVideoGeneration    Boolean   @default(false)

  // === API ===
  modelNameOnProvider   String?
  endpoints             Json?

  // === Margins ===
  modelMargin           Float     @default(0) // Extra margin for this specific model (e.g. 0.10 for +10%)

  // === Status ===
  isActive              Boolean   @default(true)
  isPreview             Boolean   @default(false)
  isSelfHosted          Boolean   @default(false)
  validFrom             DateTime?
  validUntil            DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userSettings          UserSettings[]
  generations           Generation[]
}

model Provider {
  id                    String   @id @default(cuid())
  slug                  String   @unique // "google", "openai", "anthropic"
  name                  String
  baseUrl               String?

  // Authorization
  authType              AuthType
  authHeaderName        String?
  authHeaderPrefix      String?
  authQueryParam        String?
  authTokenUrl          String?
  authScope             String?

  models                ModelTariff[]
}

enum AuthType {
  API_KEY
  BEARER_TOKEN
  X_API_KEY
  GOOGLE_OAUTH
  NONE
}

model SystemSettings {
  id          String   @id @default("singleton")
  key         String   @unique
  usdRubRate      Float    @default(100)
  hostingCost     Float    @default(0)
  systemMargin    Float    @default(0) // Global system margin (e.g. 0.05 for +5%)
  telegramChannelId String?
  isSubscriptionRequired Boolean @default(false)
  creditsPerUsd   Float    @default(100) // How many credits for 1 USD
  freeCreditsAmount Float  @default(3)   // Free credits for new users
  referralBonusAmount Float @default(50) // Bonus for referrer
  referralFirstPurchaseBonus Float @default(150) // Bonus for first purchase of referral
  updatedAt       DateTime @updatedAt
}


model Generation {
  id             String           @id @default(cuid())
  userId         String
  type           GenerationType
  prompt         String
  negativePrompt String?
  enhancedPrompt String?
  aspectRatio    String           @default("1:1")
  numberOfImages Int              @default(1)
  safetyLevel    String
  imageUrl       String?
  fileId         String?
  thumbnailUrl   String?
  status         GenerationStatus @default(PENDING)
  creditsUsed    Float
  errorMessage   String?
  metadata       Json?
  processingTime Int?
  createdAt      DateTime         @default(now())
  completedAt    DateTime?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  inputImages    InputImage[]

  // Cost & Tokens
  modelId        String?
  model          ModelTariff?     @relation(fields: [modelId], references: [modelId])
  inputTokens    Int?
  outputTokens   Int?
  totalTokens    Int?
  totalCostUsd   Float?
  costDetails    Json?            // Breakdown: { baseCost, margins: { system, user, model }, finalCost }

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
  @@index([modelId])
}

model InputImage {
  id           String     @id @default(cuid())
  generationId String
  fileId       String
  fileUrl      String?
  order        Int
  createdAt    DateTime   @default(now())
  generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
  @@index([order])
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float?
  creditsAdded  Float
  paymentMethod PaymentMethod     @default(FREE)
  paymentId     String?
  currency      String?           @default("USD")
  status        TransactionStatus @default(PENDING)
  metadata      Json?
  description   String?
  createdAt     DateTime          @default(now())
  completedAt   DateTime?
  isFinal       Boolean           @default(false)
  packageId     String?
  package       CreditPackage?    @relation(fields: [packageId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([paymentId])
  @@index([createdAt])
}

model Referral {
  id                 String   @id @default(cuid())
  referrerId         String
  referredId         String
  bonusGranted       Boolean  @default(false)
  bonusAmount        Float    @default(3)
  firstPurchase      Boolean  @default(false)
  firstPurchaseBonus Float    @default(5)
  createdAt          DateTime @default(now())
  referred           User     @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)
  referrer           User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
}

model DailyBonus {
  id            String    @id @default(cuid())
  userId        String    @unique
  streakDays    Int       @default(0)
  lastClaimDate DateTime?
  totalBonuses  Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastClaimDate])
}

model CreditPackage {
  id            String        @id @default(cuid())
  name          String
  credits       Float
  price         Float
  currency      String        @default("USD")
  discount      Int           @default(0)
  popular       Boolean       @default(false)
  active        Boolean       @default(true)
  priceYooMoney Float?
  priceStars    Int?
  priceCrypto   Float?
  description   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]

  @@index([active])
  @@index([popular])
}

model AdminUser {
  id         String   @id @default(cuid())
  telegramId BigInt?  @unique
  username   String?  @unique
  password   String?
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())
  
  adminMessages AdminMessage[]
  broadcasts    Broadcast[]

  @@index([telegramId])
  @@index([username])
}

model Analytics {
  id                    String   @id @default(cuid())
  date                  DateTime @unique @default(now())
  newUsers              Int      @default(0)
  activeUsers           Int      @default(0)
  totalGenerations      Int      @default(0)
  textToImage           Int      @default(0)
  imageToImage          Int      @default(0)
  multiImage            Int      @default(0)
  totalRevenue          Float    @default(0)
  totalCreditsUsed      Float    @default(0)
  totalCreditsPurchased Float    @default(0)
  paymentsYooMoney      Int      @default(0)
  paymentsStars         Int      @default(0)
  paymentsCrypto        Int      @default(0)

  @@index([date])
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  credits     Float
  discount    Int?
  maxUses     Int?
  currentUses Int       @default(0)
  expiresAt   DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([active])
}

model PromoCodeUsage {
  id           String   @id @default(cuid())
  code         String
  userId       String
  creditsGiven Float
  usedAt       DateTime @default(now())

  @@unique([code, userId])
  @@index([userId])
  @@index([code])
}

model AdminMessage {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminId     String?
  admin       AdminUser? @relation(fields: [adminId], references: [id])
  
  message     String
  sentAt      DateTime @default(now())
  isBroadcast Boolean  @default(false)
  broadcastId String?
  broadcast   Broadcast? @relation(fields: [broadcastId], references: [id])
  
  status      String   @default("SENT") // SENT, FAILED
  error       String?

  @@index([userId])
  @@index([sentAt])
  @@index([broadcastId])
}

model Broadcast {
  id          String   @id @default(cuid())
  message     String
  status      BroadcastStatus @default(PENDING)
  scheduledFor DateTime?
  targetNotSubscribed Boolean @default(false)
  botToken    String?
  startedAt   DateTime?
  completedAt DateTime?
  
  totalUsers  Int      @default(0)
  sentCount   Int      @default(0)
  failedCount Int      @default(0)
  
  createdBy   String?
  creator     AdminUser? @relation(fields: [createdBy], references: [id])
  
  messages    AdminMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
}

enum GenerationType {
  TEXT_TO_IMAGE
  IMAGE_TO_IMAGE
  MULTI_IMAGE
  BATCH
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionType {
  PURCHASE
  BONUS
  REFERRAL
  DAILY_BONUS
  ADMIN_ADJUSTMENT
  GENERATION_COST
  REFUND
}

enum PaymentMethod {
  YOOMONEY
  TELEGRAM_STARS
  CRYPTO
  FREE
  ADMIN
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  REFUNDED
  FAILED
  CANCELLED
}

enum BroadcastStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}


model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  mode      String   @default("help") 
  
  isFromUser Boolean @default(true)
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([mode])
}
